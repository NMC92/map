<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Portugal</title>
    </head>
    <body style="">
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

		<object class="map" id="svgmap" type="image/svg+xml" data="map.svg">
		</object>
		<span id="span"></span>
		<button type="button" id="game" >Play!</button>
		<button type="button" id="reset" >Reset</button>
		<span id="goalText"></span>
		<script>
			setTimeout(function(){
			
				const width = 250;
				const height = 366;
				const a = document.getElementById("svgmap");
				const svgDoc = a.contentDocument;
				const Distritos = svgDoc.getElementsByClassName('Distritos');
				const Concelhos = svgDoc.getElementsByClassName('Concelhos');

				
				let dists = new Array();
				let concs = new Array();
				let fregs = new Array();
				let dd = new Array();
				let dc = new Array();
				let df = new Array();
				
				for(let i = 0; i < Distritos.length; i++)
				{
					let strAux = Distritos[i].id.split('(')[0];
					strAux = strAux == "Bragança" ? "Braganca" : strAux;
					strAux = strAux == "Castelo Branco" ? "CB" : strAux;
					strAux = strAux == "Évora" ? "Evora" : strAux;
					strAux = strAux == "Santarém" ? "Santarem" : strAux;
					strAux = strAux == "Setúbal" ? "Setubal" : strAux;
					strAux = strAux == "Viana do Castelo" ? "VC" : strAux;
					strAux = strAux == "Vila Real" ? "VR" : strAux;
					for(let j = 0; j < svgDoc.getElementsByClassName(strAux).length; j++)
					{   
						test = svgDoc.getElementsByClassName(strAux)[j].id;
						test = test.replace(/ +/g, "");
						test = test.toLowerCase();
						test = test.split('(')[0]+"freg";
						for(let k = 0; k < svgDoc.getElementsByClassName(test).length; k++)
						{
							fregs.push({Name:svgDoc.getElementsByClassName(test)[k].id,Distrito:Distritos[i].id.split('(')[0],Concelho:svgDoc.getElementsByClassName(strAux)[j].id.split('(')[0],Freguesia:svgDoc.getElementsByClassName(test)[k]});
						}
						concs.push({Name:svgDoc.getElementsByClassName(strAux)[j].id,Distrito:Distritos[i].id.split('(')[0],Concelho:svgDoc.getElementsByClassName(strAux)[j],Freguesias:svgDoc.getElementsByClassName(test)});
					}
					dists.push({Name:Distritos[i].id,Distrito:Distritos[i],Concelhos:svgDoc.getElementsByClassName(strAux),Freguesias:svgDoc.getElementsByClassName("freg"+strAux.toLowerCase())});
				};
				for(let i = 0; i < dists.length; i++)
					dd.push({Path:dists[i].Distrito.attributes[0].value,Id:Distritos[i].id});
				for(let i = 0; i < concs.length; i++)
					dc.push({Path:concs[i].Concelho.attributes[0].value,Id:concs[i].Name}); 
				for(let i = 0; i < fregs.length; i++)
				{
					
					df.push({Path:fregs[i].Freguesia.attributes[0].value,Id:fregs[i].Name});
				}
				
				const span = document.getElementById("span");
				const btn = document.getElementById("reset");
				const play = document.getElementById("game");
				const goalText = document.getElementById("goalText");
				btn.style.visibility="hidden";
				
				let x = Math.floor((Math.random() * Concelhos.length)+1);
				//let goal = Concelhos[x].id;
				let guess = "";
				let tries = 999999;
				let lose = false;
				let game = false;
						
				//for(let i = 0; i < dists.length; i++)
					//dists[i].Distrito.attributes[0].value = "";
				for(let i = 0; i < concs.length; i++)
					concs[i].Concelho.attributes[0].value = "";
				for(let i = 0; i < fregs.length; i++)
					fregs[i].Freguesia.attributes[0].value = "";
				
				
				//let show = arr =>  {for(let i = 0; i < arr.length; i++) arr.item(i).style.visibility = "visible"; };
				//let hide = arr =>  {for(let i = 0; i < arr.length; i++) arr.item(i).style.visibility = "hidden"; };
				
				function answer(a, b){ return (a === b); }
				function bigger(a, b){ return (a >= b ? a : b); }
				function smaller(a, b){ return (a < b ? a : b); }
				
				function cleanConcelhos()
				{
					cleanFreguesias();
					for(let i = 0; i < dists.length; i++)
						for(let j = 0; j < dists[i].Concelhos.length; j++)
							dists[i].Concelhos[j].attributes[0].value = "";
				}
				
				function cleanFreguesias()
				{
					for(let i = 0; i < fregs.length; i++)
						fregs[i].Freguesia.attributes[0].value = ""
				}
				
				btn.addEventListener("click", reset); 
							
				function reset() 
				{ 
					cleanConcelhos();
					btn.style.visibility="hidden";
					span.innerHTML = "";
					//span.innerHTML = `Where is ${goal}?`; 
					//if(game) 
						svgDoc.children[0].setAttribute(`viewBox`, `0 0 ${width} ${height}`);
					/*else
					{
						tries = 3
						x = Math.floor((Math.random() * 278)+1);
						goal = Concelhos[x].id;
						svgDoc.children[0].setAttribute(`viewBox`, `0 0 ${width} ${height}`);
						span.innerHTML = `Where is ${goal}?`;
						//game = true;
					}*/
				}
				function showDists()
				{		
					for(let i = 0; i < dists.length; i++)
					{
						dists[i].Distrito.addEventListener("click", function(el) 
						{
							btn.style.visibility="visible";
							let x = el.clientX;
							let y = el.clientY;
							
							//span.innerHTML = el.target.id;
							//console.log(i);
							cleanConcelhos();
									let tgt = el.target.getBBox();
									
									if(i !== 1 && i != 4 && i != 6 && i !== 7)
									{
										svgDoc.children[0].setAttribute(`viewBox`, `${tgt.x-35} ${tgt.y-45} ${width/2.5} ${height/2.5}`);
									}else
										svgDoc.children[0].setAttribute(`viewBox`, `${tgt.x-08} ${tgt.y-40} ${width/2.25} ${height/2.25}`);
									span.innerHTML = el.target.id;
									for(let j = 0; j < dists[i].Concelhos.length; j++)
									{
										dists[i].Concelhos[j].attributes[0].value = dc.find(x => x.Id === dists[i].Concelhos[j].id).Path;
										dists[i].Concelhos[j].addEventListener("click", el2 => 
										{
											/*if(game)
											{
												if(answer(el2.target.id, goal))
												{
													tries = 3
													game=false;
													span.innerHTML = `Win(${el2.target.id})!`;
													btn.style.visibility="visible";
												}
												else
												{
													tries--;
													span.innerHTML = `Wrong(${el2.target.id})! Lives = ${tries}.`;
													if(tries <= 0)
													{
														game=false;
														span.innerHTML += `\nLose...`;
													}
												}
											}
											else */
											let tgt2 = el2.target.getBBox();
											let z = 200 / (tgt2.width + tgt2.height);
											svgDoc.children[0].setAttribute(`viewBox`, `${tgt2.x-((width/z)/2)} ${tgt2.y-((width/z)/2)} ${width/z} ${height/z}`);
											span.innerHTML = el2.target.id;
											cleanFreguesias();
											for(k = 0; k < concs.find(x => x.Name === dists[i].Concelhos[j].id).Freguesias.length; k++)
											{
												concs.find(x => x.Name === dists[i].Concelhos[j].id).Freguesias[k].attributes[0].value = df.find(x => x.Id === concs.find(x => x.Name === dists[i].Concelhos[j].id).Freguesias[k].id).Path;
												concs.find(x => x.Name === dists[i].Concelhos[j].id).Freguesias[k].addEventListener("click", el3 =>
												{
													span.innerHTML = el3.target.id;
												});
											}
										})
								}
						});
					}
				}
				
				play.addEventListener("click", () => 
				{
						play.style.visibility="hidden";
						/*x = Math.floor((Math.random() * 278)+1);
						goal = Concelhos[x].id;
						span.innerHTML = `Where is ${goal}?`;
						guess = "";
						tries = 3;
						game = false;
						lose = false;*/
						showDists();
				});
				
				var conc = Array.prototype.slice.call( Concelhos, 0 );
				//conc.sort((a, b) => (a.id > b.id) ? 1 : -1)
				//foreach(conc) console.log(conc.id);
			}, 500);			
		</script>
    </body>
</html>